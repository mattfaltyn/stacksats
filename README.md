# StackSats

StackSats is a Python package for developing and backtesting Bitcoin DCA ("stacking sats") allocation strategies.

It provides:
- A clean strategy interface (`WindowStrategy`)
- Built-in and example strategies
- A rolling-window backtest engine
- Feature precomputation utilities
- Validation checks for leakage, constraints, and win-rate

## Installation

Install core package for local model development:

```bash
pip install stacksats
```

For local development from source:

```bash
pip install -e .
pip install -r requirements-dev.txt
```

Install deployment dependencies only if needed:

```bash
pip install "stacksats[deploy]"
```

## Quick Start

```python
import numpy as np
import pandas as pd

from stacksats import CallableWindowStrategy, run_backtest


def my_strategy(
    features_df: pd.DataFrame,
    start_date: pd.Timestamp,
    end_date: pd.Timestamp,
    current_date: pd.Timestamp,
) -> pd.Series:
    del current_date
    window = features_df.loc[start_date:end_date]
    raw = np.exp(-window["mvrv_zscore"].to_numpy())
    w = raw / raw.sum()
    return pd.Series(w, index=window.index)


result = run_backtest(
    CallableWindowStrategy(my_strategy),
    strategy_label="my-model",
)

print(result.summary())
```

## Public API

Top-level package exports:

- `run_backtest()`: Run a rolling-window backtest for any strategy
- `validate_strategy()`: Run submission-style validation checks
- `load_data()`: Load BTC market data (with local cache support)
- `precompute_features()`: Build model features from BTC data
- `BacktestResult`: Result object with summary/plot/serialization helpers
- `ValidationResult`: Structured validation output
- `WindowStrategy`, `CallableWindowStrategy`, `MVRVStrategy`

## Writing a Strategy

Implement `compute_weights()` with this interface:

```python
def compute_weights(
    self,
    features_df: pd.DataFrame,
    start_date: pd.Timestamp,
    end_date: pd.Timestamp,
    current_date: pd.Timestamp,
) -> pd.Series:
    ...
```

Rules your strategy should satisfy:

- Return a weight series indexed by dates in the selected window
- Weights should be non-negative
- Weights should sum to `1.0`
- Avoid forward-looking data usage

### Available Features

Feature columns are generated by `precompute_features()` and typically include:

- `PriceUSD_coinmetrics`
- `price_vs_ma`
- `mvrv_zscore`
- `mvrv_gradient`
- `mvrv_percentile`
- `mvrv_acceleration`
- `mvrv_zone`
- `mvrv_volatility`
- `signal_confidence`

## Built-in and Example Strategies

### Built-in

- `MVRVStrategy`: Default strategy from the package model.

### Examples

In `stacksats.strategies.examples`:

- `UniformStrategy`
- `SimpleZScoreStrategy`
- `MomentumStrategy`

These are lightweight templates for custom model development.

## Backtesting

Run a backtest:

```python
from stacksats import MVRVStrategy, run_backtest

result = run_backtest(MVRVStrategy(), strategy_label="default-mvrv")
print(result.summary())
df = result.to_dataframe()
```

Generate plots and export JSON:

```python
paths = result.plot(output_dir="output")
payload = result.to_json("output/backtest_result.json")
```

## Validation

Validate strategy constraints:

```python
from stacksats import MVRVStrategy, validate_strategy

validation = validate_strategy(MVRVStrategy())
print(validation.summary())
print(validation.messages)
```

CLI validation is also available:

```bash
stacksats-validate --start-date 2020-01-01 --end-date 2025-01-01
```

## Command Line Tools

Installed scripts:

- `stacksats-backtest`
- `stacksats-export`
- `stacksats-plot-mvrv`
- `stacksats-plot-weights`
- `stacksats-validate`

## Advanced: Deployment

Deployment and infrastructure modules are optional:

- `stacksats.export_weights`
- `stacksats.modal_app`

These require deployment extras:

```bash
pip install "stacksats[deploy]"
```

## Development

Run tests:

```bash
pytest tests/ -v
```

Run lint:

```bash
ruff check .
```
